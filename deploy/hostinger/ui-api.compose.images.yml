version: "3.9"

# Use prebuilt images from a registry (GHCR). No sources needed on the VPS.
# Images are published by the GitHub Actions workflow in .github/workflows/build-ui-api.yml

networks:
  traefik:
    external: true
    name: ${TRAEFIK_NETWORK}

services:
  ui:
    image: ghcr.io/jmnaste/ai-workflow-automation/ui:main
    labels:
      - traefik.enable=true
      - traefik.http.routers.ui.rule=Host(`${UI_HOST}`) || Host(`${PRIMARY_HOST}`)
      - traefik.http.routers.ui.entrypoints=web,websecure
      - traefik.http.routers.ui.tls=true
      - traefik.http.routers.ui.tls.certresolver=mytlschallenge
    networks:
      - traefik
    restart: unless-stopped

  api:
    image: ghcr.io/jmnaste/ai-workflow-automation/api:main
    labels:
      - traefik.enable=true
      - traefik.http.routers.api.rule=Host(`${PRIMARY_HOST}`) && PathPrefix(`/api`)
      - traefik.http.routers.api.entrypoints=web,websecure
      - traefik.http.routers.api.tls=true
      - traefik.http.routers.api.tls.certresolver=mytlschallenge
      - traefik.http.routers.api.priority=100
    networks:
      traefik:
        aliases:
          - api
    restart: unless-stopped
