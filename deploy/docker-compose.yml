version: "3.9"

# Add-on stack to run UI + API alongside an existing Traefik+n8n on the same VPS
# Requires attaching to the same Docker network as Traefik.
# Set TRAEFIK_NETWORK to the Traefik network name (e.g., root_default or traefik_proxy).

networks:
  traefik:
    external: true
    name: ${TRAEFIK_NETWORK}

services:
  ui:
    build:
      context: ../ui
    labels:
      - traefik.enable=true
      - traefik.http.routers.ui.rule=Host(`${UI_HOST}`) || Host(`${PRIMARY_HOST}`)
      - traefik.http.routers.ui.entrypoints=web,websecure
      - traefik.http.routers.ui.tls=true
      - traefik.http.routers.ui.tls.certresolver=mytlschallenge
    networks:
      - traefik
    restart: unless-stopped

  api:
    build:
      context: ../api
    labels:
      - traefik.enable=true
      # Same-origin path routing to avoid CORS
      - traefik.http.routers.api.rule=Host(`${PRIMARY_HOST}`) && PathPrefix(`/api`)
      - traefik.http.routers.api.entrypoints=web,websecure
      - traefik.http.routers.api.tls=true
      - traefik.http.routers.api.tls.certresolver=mytlschallenge
      - traefik.http.routers.api.priority=100
    networks:
      traefik:
        aliases:
          - api
    restart: unless-stopped
