# Conversation Log — 2025-11-05 00:00 — Alembic migrations runner and API gating

What the user asked / context:
- Continue implementing per-service, transactional migrations starting with Auth.
- Record version in schema_registry and gate API on Auth min version.

Assistant’s response and actions:
- Created initial Alembic revision for Auth (`auth/alembic/versions/20251105_000001_initial_auth.py`) that:
  - Ensures `auth` schema
  - Creates tables: users, tenants, users_tenants, settings, otp_challenges, sessions, login_audit, rate_limits
  - Adds `auth.schema_registry` and writes initial version: semver 0.1.0
- Added a migration runner with advisory lock and retries: `auth/app/migrate.py`
  - Honors `MIGRATE_AT_START`, uses `MIGRATIONS_DATABASE_URL` or `DATABASE_URL`
  - Serializes concurrent starts with `pg_advisory_lock`
  - Runs Alembic `upgrade head`
- Switched Auth container CMD to a Python launcher that runs migrations then starts Uvicorn: `auth/app/start.py` and Dockerfile CMD updated.
- Exposed migration envs in compose: `MIGRATE_AT_START`, `MIGRATIONS_DATABASE_URL`.
- Documented migration behavior in `auth/README.md` and noted Alembic ownership in `postgres/migrations/README.md`.
- Implemented API startup gating on Auth min version via `API_MIN_AUTH_VERSION` in `api/app/main.py` and documented in `api/README.md`.

Notes / follow-ups:
- Future: add API’s own Alembic scaffold for `api` schema as needed.
- Consider adding health endpoint to surface schema versions for debugging.
